name: build

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15
    - name: Build binaries
      run: go run build/build.go
    - name: Run unit tests
      run: go test ./...

  integration-tests:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        provider:
# Providers that don't require secrets: (alphabetical)
        - BIND
        - HEXONET
# Providers designated "officially supported": (alphabetical)
        - AZURE_DNS
        - CLOUDFLAREAPI
        - GCLOUD
        - NAMEDOTCOM
        - ROUTE53
# All others: (alphabetical)
        - DIGITALOCEAN
        - GANDI_V5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15

    - name: Tests
      working-directory: integrationTest
      run: |
        echo DEBUG0: CAN_SECRET="$CAN_SECRET"
        echo DEBUG0: PROVIDER="$PROVIDER"
        echo DEBUG: A="$AZURE_DNS__CAN_SECRET"
        echo DEBUG: B="$BIND__CAN_SECRET"
        echo DEBUG: C="$CLOUDFLAREAPI__CAN_SECRET"
        echo DEBUG: D="$DIGITALOCEAN__CAN_SECRET"
        echo DEBUG: G="$GANDI_V5__CAN_SECRET"
        echo DEBUG: G="$GCLOUD__CAN_SECRET"
        echo DEBUG: H="$HETZNER__CAN_SECRET"
        echo DEBUG: H="$HEXONET__CAN_SECRET"
        echo DEBUG: N="$NAMEDOTCOM__CAN_SECRET"
        echo DEBUG: R="$ROUTE53__CAN_SECRET"
#      if: ${{ env[ '${{ matrix.provider }}__CAN_SECRET' ] == 'true' }}
      env:
        CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
        PROVIDER: ${{ matrix.provider }}
# ---------
        AZURE_DNS__CAN_SECRET: ${{ secrets['AZURE_DNS__CAN_SECRET'] }}
        BIND__CAN_SECRET: ${{ secrets['BIND__CAN_SECRET'] }}
        CLOUDFLAREAPI__CAN_SECRET: ${{ secrets['CLOUDFLAREAPI__CAN_SECRET'] }}
        DIGITALOCEAN__CAN_SECRET: ${{ secrets['DIGITALOCEAN__CAN_SECRET'] }}
        GANDI_V5__CAN_SECRET: ${{ secrets['GANDI_V5__CAN_SECRET'] }}
        GCLOUD__CAN_SECRET: ${{ secrets['GCLOUD__CAN_SECRET'] }}
        HETZNER__CAN_SECRET: ${{ secrets['HETZNER__CAN_SECRET'] }}
        HEXONET__CAN_SECRET: "true"
        NAMEDOTCOM__CAN_SECRET: ${{ secrets['NAMEDOTCOM__CAN_SECRET'] }}
        ROUTE53__CAN_SECRET: ${{ secrets['ROUTE53__CAN_SECRET'] }}



#    - name: Run boolean A simple
#      shell: bash
#      run: echo Hello A ${{ env['AZURE__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['AZURE__CAN_SECRET'] }}
#    - name: Run boolean A1 simple
#      shell: bash
#      run: echo Hello A ${{ env['CAN_SECRET'] }}
#      env:
#        CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#    - name: Run boolean A2 simple
#      shell: bash
#      run: echo Hello A ${{ env['${{ matrix.provider }}__CAN_SECRET'] }}  XXX '${{ matrix.provider }}__CAN_SECRET'
#      env:
#        CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#    - name: Run boolean B replace in run
#      shell: bash
#      run: echo Hello B ${{ env['${{ matrix.provider }}__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['AZURE__CAN_SECRET'] }}
#    - name: Run boolean C replace in env
#      shell: bash
#      run: echo Hello C ${{ env['AZURE__CAN_SECRET'] }} XXX '${{ matrix.provider }}__CAN_SECRET'
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#    - name: Run boolean D replace in both
#      shell: bash
#      run: echo Hello D ${{ env['${{ matrix.provider }}__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#
#    - name: Run boolean E simple
#      shell: bash
#      run: echo Hello E ${{ secrets['AZURE__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['AZURE__CAN_SECRET'] }}
#    - name: Run boolean F replace in run
#      shell: bash
#      run: echo Hello F ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['AZURE__CAN_SECRET'] }}
#    - name: Run boolean G replace in env
#      shell: bash
#      run: echo Hello G ${{ secrets['AZURE__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#    - name: Run boolean H replace in both
#      shell: bash
#      run: echo Hello H ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
#      env:
#        AZURE__CAN_SECRET: ${{ secrets['${{ matrix.provider }}__CAN_SECRET'] }}
